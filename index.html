<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cmanga Game Dashboard All-in-One</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #fff; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        /* Tab Active State */
        .tab-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        /* Custom Classes for Top Rankings */
        .top-1 { background-color: #218509 !important; color: #fff !important; font-weight: 900; }
        .top-2 { background-color: #2d89ad !important; color: #fff !important; font-weight: 700; }
        .top-3 { background-color: #0e4dc1 !important; color: #fff !important; font-weight: 700; }
        
        .loader {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Table Styles */
        .data-table th { position: sticky; top: 0; background-color: #1e293b; z-index: 10; }
		/* --- Th√™m v√†o b√™n trong th·∫ª <style> --- */

/* CSS cho b·∫£ng th·ªëng k√™ th√°ng (Sticky Columns) */
.stats-table th, .stats-table td {
    text-align: center;
    padding: 10px 8px;
    white-space: nowrap;
}
/* Ghim 2 c·ªôt ƒë·∫ßu ti√™n (ID v√† T√™n) */
.stats-table th:nth-child(1), .stats-table td:nth-child(1) {
    position: sticky; left: 0; z-index: 10; background-color: #1e293b; /* slate-800 */
    text-align: left;
}
.stats-table th:nth-child(2), .stats-table td:nth-child(2) {
    position: sticky; left: 0; z-index: 10; background-color: #1e293b;
    text-align: left;
    left: 0; /* Trong mobile c√≥ th·ªÉ c·∫ßn ch·ªânh l·∫°i, nh∆∞ng PC th√¨ OK */
}
/* Header c·ªßa b·∫£ng d√≠nh l√™n tr√™n c√πng */
.stats-table thead th {
    position: sticky; top: 0; z-index: 20; background-color: #334155; /* slate-700 */
}
/* --- Th√™m v√†o b√™n trong th·∫ª <style> --- */

/* Scrollbar container cho b·∫£ng */
.hw-table-container {
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid #334155; /* slate-700 */
    border-radius: 0.5rem;
}

/* M√†u s·ªë linh th·∫°ch */
.linhthach-text {
    font-size: 0.75rem; /* text-xs */
    background-color: #334155;
    color: #38bdf8; /* sky-400 */
    padding: 2px 8px;
    border-radius: 9999px;
    margin-left: 8px;
}
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-800 border-b border-slate-700 p-4 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold text-blue-400">‚öîÔ∏è Game Tools Hub</h1>
            <span class="text-xs bg-slate-700 px-2 py-1 rounded " id="server-status">Connecting...</span>
        </div>
        
        <div class="flex items-center gap-2 w-full md:w-auto">
            <label class="text-xs  whitespace-nowrap">API Domain:</label>
            <input type="text" id="global-domain" class="bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm w-full md:w-48 focus:outline-none focus:border-blue-500" placeholder="cmangax8.com" value="cmangax8.com">
            <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition">L∆∞u</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-16 md:w-64 bg-slate-900 border-r border-slate-700 flex flex-col shrink-0 transition-all">
            <nav class="flex-1 p-2 space-y-1">
                <button onclick="switchTab('home')" class="tab-btn active w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 text-gray-300 transition text-left border border-transparent">
                    <span>üè†</span> <span class="hidden md:inline">Trang Ch·ªß</span>
                </button>
                <button onclick="switchTab('holywar')" class="tab-btn w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 text-gray-300 transition text-left border border-transparent">
                    <span>‚öñÔ∏è</span> <span class="hidden md:inline">Th√°nh Chi·∫øn</span>
                </button>
                <button onclick="switchTab('minerals')" class="tab-btn w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 text-gray-300 transition text-left border border-transparent">
                    <span>üíé</span> <span class="hidden md:inline">Soi Kho√°ng & Theo D√µi</span>
                </button>
                <button onclick="switchTab('donation')" class="tab-btn w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 text-gray-300 transition text-left border border-transparent">
                    <span>üí∞</span> <span class="hidden md:inline">C·ªëng V√†ng T√¥ng</span>
                </button>
                <button onclick="switchTab('guildwar')" class="tab-btn w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 text-gray-300 transition text-left border border-transparent">
                    <span>üè∞</span> <span class="hidden md:inline">ƒêi·ªÉm T√¥ng Chi·∫øn</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-700 text-xs  text-center hidden md:block">
                All-in-One V1.0
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-800 relative p-4">
            
            <div id="tab-home" class="tab-content block space-y-6 max-w-4xl mx-auto mt-10 text-center">
                <h2 class="text-3xl font-bold text-white mb-4">Ch√†o m·ª´ng ƒë·∫øn v·ªõi B·ªô C√¥ng C·ª• Game</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div onclick="switchTab('holywar')" class="bg-slate-700 p-6 rounded-xl hover:bg-slate-600 cursor-pointer transition shadow-lg border border-slate-600">
                        <div class="text-4xl mb-3">‚öñÔ∏è</div>
                        <h3 class="text-xl font-bold text-blue-300">Th√°nh Chi·∫øn</h3>
                        <p class=" text-sm mt-2">Xem t·ªâ s·ªë, danh s√°ch ƒë√≥ng g√≥p Angel/Devil v√† l·ªãch s·ª≠ tr·∫≠n ƒë·∫•u.</p>
                    </div>
                    <div onclick="switchTab('minerals')" class="bg-slate-700 p-6 rounded-xl hover:bg-slate-600 cursor-pointer transition shadow-lg border border-slate-600">
                        <div class="text-4xl mb-3">üíé</div>
                        <h3 class="text-xl font-bold text-green-300">Kho√°ng & Theo D√µi</h3>
                        <p class=" text-sm mt-2">Qu√©t kho√°ng VIP, t·ª± ƒë·ªông canh gi·ªù thu ho·∫°ch v√† b√°o ƒë·ªông √¢m thanh.</p>
                    </div>
                    <div onclick="switchTab('donation')" class="bg-slate-700 p-6 rounded-xl hover:bg-slate-600 cursor-pointer transition shadow-lg border border-slate-600">
                        <div class="text-4xl mb-3">üí∞</div>
                        <h3 class="text-xl font-bold text-yellow-300">Check C·ªëng V√†ng</h3>
                        <p class=" text-sm mt-2">Ki·ªÉm tra th√†nh vi√™n t√¥ng m√¥n ƒë√£ c·ªëng hi·∫øn h√¥m nay ch∆∞a.</p>
                    </div>
                    <div onclick="switchTab('guildwar')" class="bg-slate-700 p-6 rounded-xl hover:bg-slate-600 cursor-pointer transition shadow-lg border border-slate-600">
                        <div class="text-4xl mb-3">üè∞</div>
                        <h3 class="text-xl font-bold text-red-300">ƒêi·ªÉm T√¥ng Chi·∫øn</h3>
                        <p class=" text-sm mt-2">Xem x·∫øp h·∫°ng ƒëi·ªÉm ƒë√≥ng g√≥p t√¥ng m√¥n chi·∫øn.</p>
                    </div>
                </div>
            </div>

            <div id="tab-holywar" class="tab-content hidden h-full flex flex-col pb-20">
    <div class="flex justify-between items-center mb-4 bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-lg">
        <div>
            <h2 id="hw-title" class="text-xl font-bold text-blue-400">Th√°nh Chi·∫øn (--:00)</h2>
            <div class="text-xs  mt-1" id="hw-status">ƒêang ch·ªù kh·ªüi t·∫°o...</div>
        </div>
        <div class="text-right">
            <div id="hw-clock" class="text-3xl font-mono font-bold text-white tracking-wider">--:--:--</div>
            <div class="text-xs  uppercase tracking-widest mt-1">Realtime Server</div>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-4 h-full overflow-hidden">
        
        <div class="w-full lg:w-2/3 flex flex-col gap-4 overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full overflow-hidden">
                
                <div class="bg-slate-900 rounded-xl border border-slate-700 flex flex-col overflow-hidden shadow-lg relative group">
                    <div class="p-3 bg-slate-800 border-b border-slate-700 sticky top-0 z-10 text-center">
                        <h3 class="font-bold text-sky-400 text-lg flex justify-center items-center">
                            üòá Angel <span id="angel-gems" class="linhthach-text hidden"></span>
                        </h3>
                        <div class="text-sm  mt-1">T·ªïng: <span id="angel-total" class="text-white font-mono font-bold">0</span></div>
                    </div>
                    <div class="overflow-y-auto flex-1 p-0 hw-table-container border-0">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs  uppercase bg-slate-800 sticky top-0">
                                <tr><th class="p-3">T√™n</th><th class="p-3 text-right">V√†ng</th><th class="p-3">Guild</th></tr>
                            </thead>
                            <tbody id="angel-list" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-xl border border-slate-700 flex flex-col overflow-hidden shadow-lg relative group">
                    <div class="p-3 bg-slate-800 border-b border-slate-700 sticky top-0 z-10 text-center">
                        <h3 class="font-bold text-red-500 text-lg flex justify-center items-center">
                            üòà Devil <span id="devil-gems" class="linhthach-text hidden"></span>
                        </h3>
                        <div class="text-sm  mt-1">T·ªïng: <span id="devil-total" class="text-white font-mono font-bold">0</span></div>
                    </div>
                    <div class="overflow-y-auto flex-1 p-0 hw-table-container border-0">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs  uppercase bg-slate-800 sticky top-0">
                                <tr><th class="p-3">T√™n</th><th class="p-3 text-right">V√†ng</th><th class="p-3">Guild</th></tr>
                            </thead>
                            <tbody id="devil-list" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/3 bg-slate-900 rounded-xl border border-slate-700 flex flex-col overflow-hidden shadow-lg">
            <div class="p-4 bg-slate-800 border-b border-slate-700">
                <h3 class="font-bold text-gray-200 text-center uppercase tracking-wider mb-3">L·ªãch S·ª≠ ƒê·ªëi ƒê·∫ßu</h3>
                <div class="flex justify-between text-md mb-2 px-2">
                    <span class="text-sky-400 font-bold">üòá Angel: <span id="angel-wins">0</span></span>
                    <span class="text-red-500 font-bold">üòà Devil: <span id="devil-wins">0</span></span>
                </div>
                <div class="flex justify-between text-md border-t border-slate-600 pt-2 px-2">
                    <span>T·ªïng A: <span id="angel-total-hist" class="text-sky-400">0</span></span>
                    <span>T·ªïng D: <span id="devil-total-hist" class="text-red-500">0</span></span>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 p-0">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs  uppercase bg-slate-800 sticky top-0 z-10">
                        <tr>
                            <th class="p-3">Ng√†y</th>
                            <th class="p-3">Gi·ªù</th>
                            <th class="p-3 text-center">Th·∫Øng</th>
                            <th class="p-3 text-right">V√†ng</th>
                        </tr>
                    </thead>
                    <tbody id="hw-history-list" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

            <div id="tab-minerals" class="tab-content hidden space-y-6 pb-20">
    <div class="flex flex-col md:flex-row gap-4">
        
        <div class="w-full md:w-1/2 bg-slate-900 p-4 rounded-lg border border-slate-700">
            <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                <h3 class="font-bold text-green-400">1. C·∫•u h√¨nh & Soi v·ªã tr√≠</h3>
                <button onclick="stopSound()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-1 rounded shadow transition flex items-center gap-1">
                    <span>üîï D·ª´ng Loa</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-2 mb-3">
                <div class="flex gap-2 items-center">
                    <label class="text-xs text-gray-500 w-24">ƒê·ªß 60p:</label>
                    <input type="text" id="sound-ready" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs" value="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3">
                    <button onclick="testSound('sound-ready')" class="text-xs bg-slate-700 px-2 py-1 rounded">Test</button>
                </div>
                <div class="flex gap-2 items-center">
                    <label class="text-xs text-gray-500 w-24">C√≥ ƒë·ªì VIP:</label>
                    <input type="text" id="sound-vip" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs" value="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3">
                    <button onclick="testSound('sound-vip')" class="text-xs bg-slate-700 px-2 py-1 rounded">Test</button>
                </div>
                <div class="flex gap-2 items-center">
                    <label class="text-xs text-red-500 w-24 font-bold">B·ªã C∆∞·ªõp/M·∫•t:</label>
                    <input type="text" id="sound-robbed" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs" value="https://assets.mixkit.co/active_storage/sfx/209/209-preview.mp3">
                    <button onclick="testSound('sound-robbed')" class="text-xs bg-slate-700 px-2 py-1 rounded">Test</button>
                </div>
            </div>

            <div class="flex gap-2 mb-2">
                <input type="text" id="miner-search-id" placeholder="Nh·∫≠p ID nh√¢n v·∫≠t..." class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 focus:outline-none text-white">
                <button onclick="minerals_searchOne()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white font-bold whitespace-nowrap">üîç Soi T√¨m T·∫ßng</button>
            </div>
             <button onclick="minerals_scanAll()" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded text-gray-300 font-bold text-xs border border-slate-600">Qu√©t to√†n b·ªô 11 T·∫ßng (T√¨m ƒë·ªì VIP)</button>
             <div id="scan-status" class="text-xs text-center mt-1 text-gray-400 h-4"></div>
        </div>

        <div class="w-full md:w-1/2 bg-slate-900 p-4 rounded-lg border border-slate-700 shadow-lg border-l-4 border-l-yellow-600">
            <h3 class="font-bold text-yellow-400 mb-2 border-b border-slate-700 pb-2">2. Theo D√µi T·ª± ƒê·ªông (Auto Monitor)</h3>
            
            <div class="flex gap-2 mb-2">
                <input type="text" id="monitor-input-id" placeholder="ID Nh√¢n v·∫≠t" class="w-3/5 bg-slate-800 border border-slate-600 rounded px-3 py-1 focus:outline-none text-sm text-white">
                <input type="number" id="monitor-input-area" placeholder="T·∫ßng (1-11)" class="w-2/5 bg-slate-800 border border-slate-600 rounded px-3 py-1 focus:outline-none text-sm text-white" min="1" max="11">
                <button onclick="monitor_add()" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-white font-bold text-sm whitespace-nowrap">Th√™m</button>
            </div>

            <div class="overflow-y-auto max-h-64 border border-slate-700 rounded bg-slate-800">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-700 text-xs uppercase sticky top-0 text-gray-300">
                        <tr>
                            <th class="p-2">ID</th>
                            <th class="p-2 text-center">T·∫ßng</th>
                            <th class="p-2 text-center">Time</th>
                            <th class="p-2 text-right">VIP</th>
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="monitor-list" class="divide-y divide-slate-700/50">
                        </tbody>
                </table>
            </div>
            <div class="text-xs text-gray-500 mt-2 italic flex justify-between">
                <span>* T·ª± ƒë·ªông check m·ªói 60s.</span>
                <span id="monitor-last-check">---</span>
            </div>
        </div>
    </div>

    <div id="minerals-result-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-fade-in">
        </div>
</div>

            <div id="tab-donation" class="tab-content hidden space-y-6 pb-20">
    
    <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 shadow-lg">
        <div class="flex flex-col lg:flex-row gap-4 items-end">
            <div class="w-full lg:w-1/3">
                <label class="text-xs  font-bold uppercase tracking-wider mb-1 block">ID T√¥ng M√¥n</label>
                <input type="text" id="donate-guild-id" 
                       class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" 
                       placeholder="VD: 64">
            </div>

            <button onclick="donation_check(true)" 
                    class="w-full lg:w-auto bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg font-bold h-[42px] shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                Ki·ªÉm tra ngay
            </button>

             <div class="w-full lg:w-auto ml-auto">
                 <details class="group">
                    <summary class="flex items-center gap-2 cursor-pointer text-xs text-blue-400 hover:text-blue-300 transition select-none">
                        <span>‚öôÔ∏è C·∫•u h√¨nh ƒê·ªìng b·ªô (GitHub)</span>
                        <span class="transition group-open:rotate-180">‚ñº</span>
                    </summary>
                    <div class="absolute right-4 mt-2 w-full max-w-md bg-slate-800 p-4 rounded-lg shadow-xl border border-slate-600 z-50">
                        <label class="text-xs  mb-1 block">URL File JSON History (GitHub Raw)</label>
                        <input type="url" value="https://raw.githubusercontent.com/minhluan0010/Cmanga-Game-Dashboard/main/donation_history.json" id="sync-url-input" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white mb-2">
                        <button onclick="syncFromGithubToLocal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 rounded font-bold">
                            ƒê·ªìng b·ªô ngay (GitHub ‚Üí Local)
                        </button>
                    </div>
                 </details>
             </div>
        </div>
        <div class="text-xs  mt-2 italic" id="auto-check-status"></div>
    </div>

    <div class="flex flex-col items-center justify-center py-4 animate-fade-in">
        <img id="guild-avatar-img" class="w-24 h-24 rounded-full border-4 border-slate-700 shadow-2xl object-cover mb-3" src="https://placehold.co/96x96/1e293b/cbd5e1?text=..." alt="Guild Logo">
        <h2 id="guild-name-display" class="text-2xl font-bold text-white tracking-tight">---</h2>
        <span class="text-xs bg-slate-700 text-gray-300 px-2 py-1 rounded mt-1">ID: <span id="guild-id-display">--</span></span>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden group">
            <div class="absolute right-0 top-0 p-4 transition text-6xl">üë•</div>
            <div class="text-sm  uppercase tracking-wider font-semibold">Th√†nh vi√™n</div>
            <div id="donate-total" class="text-3xl font-bold text-white mt-1">0</div>
        </div>
        <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden group">
            <div class="absolute right-0 top-0 p-4 transition text-6xl text-green-500">üí∞</div>
            <div class="text-sm  uppercase tracking-wider font-semibold">ƒê√£ c·ªëng h√¥m nay</div>
            <div id="donate-done" class="text-3xl font-bold text-green-400 mt-1">0</div>
        </div>
        <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden group">
            <div class="absolute right-0 top-0 p-4 transition text-6xl text-blue-500">üìä</div>
            <div class="text-sm  uppercase tracking-wider font-semibold">T·ª∑ l·ªá ho√†n th√†nh</div>
            <div id="donate-percent" class="text-3xl font-bold text-blue-400 mt-1">0%</div>
        </div>
    </div>

    <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
        <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <span class="w-2 h-6 bg-teal-500 rounded-full inline-block"></span>
                Danh S√°ch C·ªëng Hi·∫øn H√¥m Nay
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left ">
                <thead class="text-xs text-gray-300 uppercase bg-slate-800/80">
                    <tr>
                        <th class="px-6 py-3">Th√†nh vi√™n</th> <th class="px-6 py-3">Ch·ª©c v·ª•</th>
                        <th class="px-6 py-3 text-right">V√†ng C·ªëng</th>
                        <th class="px-6 py-3 text-right">Online cu·ªëi</th>
                    </tr>
                </thead>
                <tbody id="donate-list" class="divide-y divide-slate-700">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
        <div class="p-4 bg-slate-800/50 border-b border-slate-700">
             <h3 class="font-bold text-white flex items-center gap-2" id="monthly-stats-title">
                <span class="w-2 h-6 bg-blue-500 rounded-full inline-block"></span>
                Th·ªëng k√™ th√°ng...
            </h3>
        </div>
        <div class="overflow-x-auto max-h-[600px]"> <table class="w-full text-sm stats-table border-collapse">
                <thead class="bg-slate-800 text-xs uppercase text-gray-300 sticky top-0 z-20" id="monthly-stats-header">
                    </thead>
                <tbody id="monthly-stats-list" class="divide-y divide-slate-700">
                    </tbody>
            </table>
        </div>
    </div>
</div>

            <div id="tab-guildwar" class="tab-content hidden space-y-4">
                 <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 flex flex-col sm:flex-row gap-4 items-end">
                    <div class="w-full sm:w-1/2">
                        <label class="text-xs ">T√™n T√¥ng M√¥n (Ch√≠nh x√°c)</label>
                        <input type="text" id="gw-name-input" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white" placeholder="VD: T√™nGuild...">
                    </div>
                    <button onclick="guildwar_filter()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded font-bold w-full sm:w-auto h-[42px]">L·ªçc ƒêi·ªÉm</button>
                </div>
                <div id="gw-result" class="bg-slate-900 rounded-lg border border-slate-700 p-4 min-h-[200px]">
                    <p class=" text-center italic">Nh·∫≠p t√™n Guild v√† b·∫•m L·ªçc ƒë·ªÉ xem ƒëi·ªÉm.</p>
                </div>
            </div>

        </main>
    </div>

    <audio id="audio-player"></audio>

<script>
// --- Helper Functions m·ªõi ---
function getAvatarUrl(avatarFile) {
    if (!avatarFile || avatarFile === 'default.png') return 'https://placehold.co/64x64/374151/e5e7eb?text=?';
    return `https://${API_DOMAIN}/assets/tmp/avatar/${avatarFile}`;
}
function getGuildAvatarUrl(avatarFile) {
    if (!avatarFile || avatarFile === 'default.png') return 'https://placehold.co/96x96/1e293b/cbd5e1?text=G';
    return `https://${API_DOMAIN}/assets/tmp/game/guild/${avatarFile}`;
}
    // ================= GLOBAL SETTINGS =================
    let API_DOMAIN = localStorage.getItem('cmanga_api_domain') || 'cmangax8.com';
    let SOUND_READY = localStorage.getItem('sound_ready') || 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3';
    let SOUND_VIP = localStorage.getItem('sound_vip') || 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3';
    let CURRENT_DONATION_GUILD_ID = localStorage.getItem('donate_guild_id') || '';
	// ... (C√°c bi·∫øn API_DOMAIN, SOUND_READY, v.v.) ...
	const AUTO_CHECK_GUILDS = ['64', '40']; // ID c·ªßa c√°c t√¥ng ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u tr√™n GitHub
	const GITHUB_HISTORY_URL = `https://raw.githubusercontent.com/minhluan0010/Cmanga-Game-Dashboard/main/donation_history.json`; 
	// !!! QUAN TR·ªåNG: THAY TH·∫æ <YOUR_USERNAME> V√Ä <YOUR_REPO_NAME> B·∫∞NG C·ª¶A B·∫†N !!!

	const DONATION_STORAGE_KEY = 'cmanga_donation_history_v3_local'; // D√πng cho d·ªØ li·ªáu nh·∫≠p tay

	let SHARED_GITHUB_HISTORY = {}; // D·ªØ li·ªáu l·ªãch s·ª≠ ƒë∆∞·ª£c t·∫£i v·ªÅ t·ª´ GitHub

    // Init inputs
    document.getElementById('global-domain').value = API_DOMAIN;
    // ... (Init for sound/monitor not shown for brevity) ...
    document.getElementById('donate-guild-id').value = CURRENT_DONATION_GUILD_ID;

    function saveSettings() {
        const newDomain = document.getElementById('global-domain').value.trim().replace(/^https?:\/\//, '').replace(/\/$/, '');
        API_DOMAIN = newDomain;
        localStorage.setItem('cmanga_api_domain', API_DOMAIN);
        
        SOUND_READY = document.getElementById('sound-ready').value;
        SOUND_VIP = document.getElementById('sound-vip').value;
        localStorage.setItem('sound_ready', SOUND_READY);
        localStorage.setItem('sound_vip', SOUND_VIP);

        alert('ƒê√£ l∆∞u c·∫•u h√¨nh!');
        location.reload(); // Reload to apply
    }

    function getApiUrl(path) {
        return `https://${API_DOMAIN}${path}`;
    }

    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active', 'bg-slate-800'));
        
        // Show selected
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        
        // Active button style
        // Simple iteration to find the button calling this or by index (simplified here)
        const buttons = document.querySelectorAll('.tab-btn');
        if(tabName === 'home') buttons[0].classList.add('active');
        if(tabName === 'holywar') { buttons[1].classList.add('active'); initHolyWar(); }
        if(tabName === 'minerals') { buttons[2].classList.add('active'); initMinerals(); }
        if(tabName === 'donation') buttons[3].classList.add('active');
        if(tabName === 'guildwar') buttons[4].classList.add('active');
    }

    // Helper: Number format
    function formatNumber(num) {
        return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
    }

    // --- AUDIO CONTROL FUNCTIONS ---

    // H√†m ph√°t √¢m thanh (C·∫≠p nh·∫≠t: Reset v·ªÅ 0 tr∆∞·ªõc khi ph√°t ƒë·ªÉ tr√°nh l·ªói)
    function playSound(type) {
        const audio = document.getElementById('audio-player');
        if (!audio) return;

        // D·ª´ng √¢m thanh c≈© n·∫øu ƒëang ch·∫°y
        audio.pause();
        audio.currentTime = 0;

        // Ch·ªçn ngu·ªìn √¢m thanh
        if (type === 'vip') audio.src = localStorage.getItem('sound_vip') || SOUND_VIP;
        else if (type === 'robbed') audio.src = document.getElementById('sound-robbed').value;
        else audio.src = localStorage.getItem('sound_ready') || SOUND_READY;
        
        // Ph√°t
        audio.play().catch(e => console.log("Audio play failed (User interaction needed):", e));
    }

    // H√†m Test √¢m thanh (C·∫≠p nh·∫≠t: Reset v·ªÅ 0 tr∆∞·ªõc khi ph√°t)
    function testSound(inputId) {
        const url = document.getElementById(inputId).value;
        const audio = document.getElementById('audio-player');
        if (!audio) return;

        audio.pause();
        audio.currentTime = 0;
        
        audio.src = url;
        audio.play().catch(e => alert("Kh√¥ng th·ªÉ ph√°t √¢m thanh. Link c√≥ th·ªÉ b·ªã l·ªói ho·∫∑c tr√¨nh duy·ªát ch·∫∑n."));
    }

    // [M·ªöI] H√†m D·ª´ng √Çm Thanh
    function stopSound() {
        const audio = document.getElementById('audio-player');
        if (audio) {
            audio.pause();       // T·∫°m d·ª´ng
            audio.currentTime = 0; // Tua v·ªÅ ƒë·∫ßu
            console.log("ƒê√£ d·ª´ng √¢m thanh th·ªß c√¥ng.");
        }
    }

    // ================= 1. HOLY WAR LOGIC =================
    // ================= 1. HOLY WAR LOGIC (N√ÇNG C·∫§P) =================
    let hwClockInterval = null;
    let hwAutoRefreshInterval = null;
    let hwIsRefreshing = false; // Tr·∫°ng th√°i ƒëang auto refresh (ph√∫t 55 -> 00)
    let hwIsInit = false;

    function initHolyWar() {
        if (hwIsInit) return;
        hwIsInit = true;
        
        // Kh·ªüi ƒë·ªông ƒë·ªìng h·ªì ngay l·∫≠p t·ª©c
        clockManager(); 
        hwClockInterval = setInterval(clockManager, 1000);
        
        // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
        loadAllHolyWarData();
    }

    // --- H√†m qu·∫£n l√Ω th·ªùi gian & Logic t·ª± ƒë·ªông refresh ---
    function clockManager() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = now.getMinutes();
        const seconds = String(now.getSeconds()).padStart(2, '0');

        // Update UI ƒê·ªìng h·ªì
        const clockEl = document.getElementById('hw-clock');
        if(clockEl) clockEl.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${seconds}`;
        
        // Update Ti√™u ƒë·ªÅ tr·∫≠n ti·∫øp theo
        const nextHour = String((now.getHours() + 1) % 24).padStart(2, '0');
        const titleEl = document.getElementById('hw-title');
        if(titleEl) titleEl.textContent = `Th√°nh Chi·∫øn (${nextHour}:00)`;

        // --- LOGIC QUAN TR·ªåNG: T·ª± ƒë·ªông Refresh t·ª´ ph√∫t 55 ---
        
        // 1. K√≠ch ho·∫°t ch·∫ø ƒë·ªô nhanh (ph√∫t 55 tr·ªü ƒëi)
        if (minutes >= 55 && !hwIsRefreshing) {
            hwIsRefreshing = true;
            document.getElementById('hw-status').textContent = "‚ö° CH·∫æ ƒê·ªò CAO ƒêI·ªÇM: C·∫≠p nh·∫≠t 30s/l·∫ßn";
            document.getElementById('hw-status').className = "text-xs text-yellow-400 font-bold animate-pulse mt-1";
            
            // G·ªçi ngay l·∫≠p t·ª©c
            fetchHolyWarContributions();
            // ƒê·∫∑t l·ªãch 30s
            hwAutoRefreshInterval = setInterval(fetchHolyWarContributions, 30000);
        }

        // 2. Reset ch·∫ø ƒë·ªô (Qua gi·ªù m·ªõi, ph√∫t 00 gi√¢y 30)
        // (Ch·ªù 30s ƒë·ªÉ server game k·ªãp t√≠nh to√°n xong k·∫øt qu·∫£)
        if (minutes === 0 && now.getSeconds() >= 30 && hwIsRefreshing) {
            hwIsRefreshing = false;
            clearInterval(hwAutoRefreshInterval); // D·ª´ng 30s
            
            document.getElementById('hw-status').textContent = "ƒê√£ qua gi·ªù m·ªõi. ƒêang t·∫£i l·∫°i l·ªãch s·ª≠...";
            document.getElementById('hw-status').className = "text-xs text-green-400 mt-1";

            // T·∫£i l·∫°i to√†n b·ªô (bao g·ªìm L·ªãch s·ª≠ m·ªõi)
            loadAllHolyWarData();
        }
    }

    // --- H√†m t·∫£i T·∫§T C·∫¢ (L·ªãch s·ª≠ + ƒêi·ªÉm) ---
    async function loadAllHolyWarData() {
        document.getElementById('hw-status').textContent = "ƒêang t·∫£i d·ªØ li·ªáu...";
        await Promise.all([fetchHolyWarHistory(), fetchHolyWarContributions()]);
        if (!hwIsRefreshing) {
            document.getElementById('hw-status').textContent = "Tr·∫°ng th√°i: Ch·ªù (T·ª± ƒë·ªông ch·∫°y l√∫c xx:55)";
            document.getElementById('hw-status').className = "text-xs  mt-1";
        }
    }

    // --- H√†m t·∫£i L·ªäCH S·ª¨ (Ch·ªâ c·∫ßn g·ªçi 1 l·∫ßn ho·∫∑c khi qua gi·ªù) ---
    async function fetchHolyWarHistory() {
        try {
            const res = await fetch(getApiUrl('/api/data?data=game_data'));
            const data = await res.json();
            renderHolyWarHistory(data.angel_devil.history);
        } catch (e) { console.error("History Error", e); }
    }

    // --- H√†m t·∫£i ƒêI·ªÇM S·ªê & LINH TH·∫†CH (G·ªçi li√™n t·ª•c) ---
    async function fetchHolyWarContributions() {
        try {
            const [angelRes, devilRes, gemsRes] = await Promise.all([
                fetch(getApiUrl('/api/score_list?type=ad_angel&limit=100')),
                fetch(getApiUrl('/api/score_list?type=ad_devil&limit=100')),
                fetch(getApiUrl('/api/ad_request_remain'))
            ]);

            const angelData = await angelRes.json();
            const devilData = await devilRes.json();
            const gemsData = await gemsRes.json();

            renderHolyWarContributions(angelData, devilData, gemsData);
            
            // C·∫≠p nh·∫≠t timestamp
            if(hwIsRefreshing) {
                 const t = new Date();
                 document.getElementById('hw-status').textContent = `‚ö° C·∫≠p nh·∫≠t: ${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`;
            }

        } catch (e) { console.error("Contribution Error", e); }
    }

    // --- Render Tables ---
    function renderHolyWarContributions(angel, devil, gems) {
        // Render Gems
        const ag = document.getElementById('angel-gems');
        const dg = document.getElementById('devil-gems');
        
        ag.classList.add('hidden'); dg.classList.add('hidden');
        ag.textContent = ''; dg.textContent = '';

        if(gems.devil > 0) { 
            ag.textContent = `-${formatNumber(gems.devil)} üíé`; 
            ag.classList.remove('hidden'); 
        }
        else if(gems.angel > 0) { 
            dg.textContent = `-${formatNumber(gems.angel)} üíé`; 
            dg.classList.remove('hidden'); 
        }

        // Render Angel List
        let aTotal = 0;
        document.getElementById('angel-list').innerHTML = angel.map((item, idx) => {
            const info = JSON.parse(item.info);
            const score = parseInt(item.score);
            aTotal += score;
            const rankClass = idx === 0 ? 'top-1' : (idx === 1 ? 'top-2' : (idx === 2 ? 'top-3' : ''));
            const rowClass = rankClass || 'hover:bg-slate-700/50 transition';
            const textClass = rankClass ? 'text-white' : 'text-gray-300';
            
            return `<tr class="border-b border-slate-700 ${rowClass}">
                <td class="p-3 font-medium ${textClass}">${info.name}</td>
                <td class="p-3 text-right font-mono ${textClass}">${formatNumber(score)}</td>
                <td class="p-3 text-xs  truncate max-w-[80px]">${info.guild?.name || '-'}</td>
            </tr>`;
        }).join('');
        document.getElementById('angel-total').textContent = formatNumber(aTotal);

        // Render Devil List
        let dTotal = 0;
        document.getElementById('devil-list').innerHTML = devil.map((item, idx) => {
            const info = JSON.parse(item.info);
            const score = parseInt(item.score);
            dTotal += score;
            const rankClass = idx === 0 ? 'top-1' : (idx === 1 ? 'top-2' : (idx === 2 ? 'top-3' : ''));
            const rowClass = rankClass || 'hover:bg-slate-700/50 transition';
            const textClass = rankClass ? 'text-white' : 'text-gray-300';

            return `<tr class="border-b border-slate-700 ${rowClass}">
                <td class="p-3 font-medium ${textClass}">${info.name}</td>
                <td class="p-3 text-right font-mono ${textClass}">${formatNumber(score)}</td>
                <td class="p-3 text-xs  truncate max-w-[80px]">${info.guild?.name || '-'}</td>
            </tr>`;
        }).join('');
        document.getElementById('devil-total').textContent = formatNumber(dTotal);
    }

    function renderHolyWarHistory(historyData) {
        let aWin=0, dWin=0;
        let aGoldSum=0, dGoldSum=0;
        
        const arr = Object.keys(historyData).map(k => ({...historyData[k], time: new Date(historyData[k].time)}));
        arr.sort((a,b) => b.time - a.time);

        const html = arr.map(m => {
            const isAngel = m.team === 'angel';
            if(isAngel) { aWin++; aGoldSum += m.total; }
            else { dWin++; dGoldSum += m.total; }
            
            const dateStr = `${String(m.time.getDate()).padStart(2,'0')}/${String(m.time.getMonth()+1).padStart(2,'0')}`;
            const hourStr = `${String(m.time.getHours()).padStart(2,'0')}:00`;

            return `<tr class="hover:bg-slate-800/50 transition">
                <td class="p-3  font-mono text-xs">${dateStr}</td>
                <td class="p-3  font-mono text-xs">${hourStr}</td>
                <td class="p-3 text-center font-bold ${isAngel ? 'text-sky-400' : 'text-red-500'}">
                    ${isAngel ? 'üòá' : 'üòà'} ${m.team.toUpperCase()}
                </td>
                <td class="p-3 text-right font-mono text-gray-300">${formatNumber(m.total)}</td>
            </tr>`;
        }).join('');

        document.getElementById('hw-history-list').innerHTML = html;
        document.getElementById('angel-wins').textContent = aWin;
        document.getElementById('devil-wins').textContent = dWin;
        document.getElementById('angel-total-hist').textContent = formatNumber(aGoldSum);
        document.getElementById('devil-total-hist').textContent = formatNumber(dGoldSum);
    }


    // ================= 2. MINERALS LOGIC (N√ÇNG C·∫§P) =================
    // Load config
    let SOUND_ROBBED = localStorage.getItem('sound_robbed') || 'https://assets.mixkit.co/active_storage/sfx/209/209-preview.mp3';
    document.getElementById('sound-robbed').value = SOUND_ROBBED;

    // Data structure: { id: "...", area: 1, lastStatus: "normal/vip/missing", lastTime: 0 }
    let monitoredMiners = JSON.parse(localStorage.getItem('monitored_miners_v2') || '[]');
    let monitorInterval = null;

    function initMinerals() {
        renderMonitorList();
        if(!monitorInterval) {
            monitorInterval = setInterval(monitorLoop, 60000); // 60s loop
            monitorLoop(); // Run immediately
        }
    }

    // --- Monitor Actions ---
    
    // Th√™m ng∆∞·ªùi theo d√µi
    function monitor_add() {
        const id = document.getElementById('monitor-input-id').value.trim();
        const area = parseInt(document.getElementById('monitor-input-area').value.trim());

        if(!id || !area) { alert('Vui l√≤ng nh·∫≠p ID v√† T·∫ßng!'); return; }
        if(monitoredMiners.find(m => m.id === id)) { alert('ID n√†y ƒëang ƒë∆∞·ª£c theo d√µi r·ªìi.'); return; }

        monitoredMiners.push({ id: id, area: area, lastStatus: 'init', lastTime: 0 });
        saveMonitor();
        renderMonitorList();
        
        // Reset input
        document.getElementById('monitor-input-id').value = '';
        
        // Check ngay l·∫≠p t·ª©c cho ID m·ªõi
        monitorLoop();
    }
    
    // Th√™m nhanh t·ª´ n√∫t "Theo D√µi" ·ªü th·∫ª k·∫øt qu·∫£
    function monitor_add_quick(id, area) {
        document.getElementById('monitor-input-id').value = id;
        document.getElementById('monitor-input-area').value = area;
        monitor_add();
        // Scroll l√™n b·∫£ng theo d√µi
        document.getElementById('monitor-list').scrollIntoView({ behavior: 'smooth' });
    }

    function monitor_remove(id) {
        if(confirm('D·ª´ng theo d√µi ID n√†y?')) {
            monitoredMiners = monitoredMiners.filter(m => m.id !== id);
            saveMonitor();
            renderMonitorList();
        }
    }

    function saveMonitor() {
        localStorage.setItem('monitored_miners_v2', JSON.stringify(monitoredMiners));
        
        // L∆∞u setting √¢m thanh
        SOUND_ROBBED = document.getElementById('sound-robbed').value;
        localStorage.setItem('sound_robbed', SOUND_ROBBED);
    }

    // Render danh s√°ch theo d√µi
    function renderMonitorList() {
        const tbody = document.getElementById('monitor-list');
        if (monitoredMiners.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 text-xs">Ch∆∞a theo d√µi ai. H√£y Soi tr∆∞·ªõc r·ªìi th√™m v√†o ƒë√¢y.</td></tr>';
            return;
        }

        tbody.innerHTML = monitoredMiners.map(m => {
            let statusClass = 'text-gray-300';
            let timeText = m.lastTime + 'p';
            
            // M√†u s·∫Øc tr·∫°ng th√°i
            if (m.lastStatus === 'missing') {
                timeText = 'M·∫§T T√çCH';
                statusClass = 'text-red-500 font-bold animate-pulse';
            } else if (m.lastTime >= 60) {
                statusClass = 'text-green-400 font-bold';
            }

            return `
            <tr class="border-b border-slate-700 hover:bg-slate-700/50 transition">
                <td class="p-2 font-mono text-blue-300 text-xs">${m.id}</td>
                <td class="p-2 text-center text-gray-400 text-xs">${m.area}</td>
                <td class="p-2 text-center ${statusClass} text-sm" id="time-${m.id}">${timeText}</td>
                <td class="p-2 text-right text-xs" id="vip-${m.id}">${m.hasVip ? 'üíé VIP' : '-'}</td>
                <td class="p-2 text-right">
                    <button onclick="monitor_remove('${m.id}')" class="text-red-400 hover:text-white px-2">√ó</button>
                </td>
            </tr>
            `;
        }).join('');
    }

    // --- CORE LOGIC: MONITOR LOOP ---
    async function monitorLoop() {
        if (monitoredMiners.length === 0) return;
        
        const nowStr = new Date().toLocaleTimeString();
        document.getElementById('monitor-last-check').textContent = `Check: ${nowStr}`;
        console.log(`[Miner Monitor] B·∫Øt ƒë·∫ßu qu√©t l√∫c ${nowStr}`);

        // 1. Gom nh√≥m c√°c t·∫ßng c·∫ßn qu√©t (Tr√°nh g·ªçi API tr√πng l·∫∑p)
        // V√≠ d·ª•: Theo d√µi 3 ng∆∞·ªùi ·ªü t·∫ßng 1, 2 ng∆∞·ªùi ·ªü t·∫ßng 5 -> Ch·ªâ g·ªçi API t·∫ßng 1 v√† 5.
        const areasToScan = [...new Set(monitoredMiners.map(m => m.area))];
        const areaDataCache = {};

        // 2. T·∫£i d·ªØ li·ªáu c√°c t·∫ßng c·∫ßn thi·∫øt
        await Promise.all(areasToScan.map(async (areaId) => {
            try {
                const res = await fetch(getApiUrl(`/api/score_list?type=battle_mine&area=${areaId}`));
                const data = await res.json();
                areaDataCache[areaId] = data; // L∆∞u l·∫°i k·∫øt qu·∫£
            } catch (e) {
                console.error(`L·ªói t·∫£i t·∫ßng ${areaId}`, e);
                areaDataCache[areaId] = null; // ƒê√°nh d·∫•u l·ªói
            }
        }));

        // 3. Ki·ªÉm tra t·ª´ng ng∆∞·ªùi trong danh s√°ch
        monitoredMiners.forEach(miner => {
            const floorData = areaDataCache[miner.area];
            
            // N·∫øu API l·ªói ho·∫∑c r·ªóng, b·ªè qua, kh√¥ng b√°o ƒë·ªông (tr√°nh b√°o ·∫£o)
            if (!floorData || !Array.isArray(floorData)) return;

            // T√¨m nh√¢n v·∫≠t trong d·ªØ li·ªáu t·∫ßng ƒë√≥
            const foundData = floorData.find(x => x.target === miner.id);

            if (foundData) {
                // --> TR∆Ø·ªúNG H·ª¢P: T√åM TH·∫§Y
                const parsed = JSON.parse(foundData.data);
                const info = extractMinerInfo(parsed);
                const minutes = info.times || 0;
                const hasVip = checkTargetValuable(info.rewards, minutes);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                miner.lastTime = minutes;
                miner.hasVip = hasVip;
                
                // N·∫øu tr∆∞·ªõc ƒë√≥ ƒëang b√°o m·∫•t t√≠ch, gi·ªù th·∫•y l·∫°i -> Reset v·ªÅ normal
                if (miner.lastStatus === 'missing') miner.lastStatus = 'normal';

                // LOGIC B√ÅO ƒê·ªòNG (SOUND)
                // 1. V·ª´a ƒë·ªß 60p (tr∆∞·ªõc ƒë√≥ < 60)
                if (miner.lastTime < 60 && minutes >= 60) {
                    playSound('ready'); 
                    console.log(`üîî ID ${miner.id} ƒë·ªß 60p!`);
                }
                // 2. ƒê√£ > 60p V√Ä C√≥ ƒë·ªì VIP
                // (ƒê·ªÉ tr√°nh spam, c√≥ th·ªÉ th√™m c·ªù check ƒë√£ b√°o ch∆∞a, nh∆∞ng user y√™u c·∫ßu b√°o khi c√≥)
                if (minutes >= 60 && hasVip) {
                    playSound('vip');
                }

                // C·∫≠p nh·∫≠t UI d√≤ng ƒë√≥
                const timeEl = document.getElementById(`time-${miner.id}`);
                const vipEl = document.getElementById(`vip-${miner.id}`);
                if(timeEl) {
                    timeEl.textContent = `${minutes}p`;
                    timeEl.className = `p-2 text-center text-sm ${minutes>=60 ? 'text-green-400 font-bold' : 'text-yellow-500'}`;
                }
                if(vipEl) vipEl.innerHTML = hasVip ? '<span class="text-yellow-400 font-bold animate-pulse">üíé VIP</span>' : '-';

            } else {
                // --> TR∆Ø·ªúNG H·ª¢P: KH√îNG T√åM TH·∫§Y (M·∫§T T√çCH / B·ªä C∆Ø·ªöP)
                
                // Ch·ªâ b√°o ƒë·ªông n·∫øu tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥ KH√îNG ph·∫£i l√† init (m·ªõi th√™m) v√† ch∆∞a b√°o missing
                if (miner.lastStatus !== 'missing' && miner.lastStatus !== 'init') {
                    console.log(`üö® ID ${miner.id} ƒë√£ bi·∫øn m·∫•t kh·ªèi t·∫ßng ${miner.area}! (B·ªã c∆∞·ªõp/Thu h·ªìi)`);
                    playSound('robbed');
                    
                    miner.lastStatus = 'missing'; // ƒê√°nh d·∫•u ƒë√£ m·∫•t ƒë·ªÉ kh√¥ng b√°o l·∫°i l·∫ßn sau
                    
                    // C·∫≠p nh·∫≠t UI b√°o ƒë·ªè
                    const timeEl = document.getElementById(`time-${miner.id}`);
                    if(timeEl) {
                        timeEl.textContent = 'B·ªä C∆Ø·ªöP!';
                        timeEl.className = 'p-2 text-center text-red-500 font-bold animate-pulse text-xs';
                    }
                } else if (miner.lastStatus === 'init') {
                    // M·ªõi th√™m v√†o m√† kh√¥ng th·∫•y ƒë√¢u lu√¥n -> C√≥ th·ªÉ nh·∫≠p sai t·∫ßng ho·∫∑c ID
                    miner.lastStatus = 'missing'; 
                }
            }
        });

        // L∆∞u l·∫°i tr·∫°ng th√°i m·ªõi nh·∫•t
        saveMonitor();
    }

    // C·∫≠p nh·∫≠t h√†m playSound ƒë·ªÉ h·ªó tr·ª£ lo·∫°i 'robbed'
    function playSound(type) {
        const audio = document.getElementById('audio-player');
        if (type === 'vip') audio.src = localStorage.getItem('sound_vip') || SOUND_VIP;
        else if (type === 'robbed') audio.src = document.getElementById('sound-robbed').value;
        else audio.src = localStorage.getItem('sound_ready') || SOUND_READY;
        
        audio.play().catch(e => console.log("Audio play failed:", e));
    }

    // --- Search Logic (Gi·ªØ nguy√™n nh∆∞ng s·ª≠a UI Card) ---
    async function minerals_searchOne(inputVal) {
        const query = inputVal || document.getElementById('miner-search-id').value.trim();
        if(!query) { alert("Nh·∫≠p ID c·∫ßn t√¨m!"); return; }
        
        const container = document.getElementById('minerals-result-area');
        container.innerHTML = '<div class="col-span-full text-center text-yellow-400 py-4"><div class="loader mx-auto mb-2"></div>ƒêang qu√©t 11 t·∫ßng ƒë·ªÉ t√¨m ID: ' + query + '...</div>';

        // Load all data
        const promises = [];
        for(let i=1; i<=11; i++) promises.push(fetch(getApiUrl(`/api/score_list?type=battle_mine&area=${i}`)).then(r=>r.json()).catch(()=>[]));
        
        try {
            const results = await Promise.all(promises);
            // results l√† m·∫£ng c√°c m·∫£ng [[...tang1], [...tang2]]
            
            let foundItem = null;
            let foundArea = null;

            // T√¨m trong m·∫£ng k·∫øt qu·∫£
            for(let i=0; i<results.length; i++) {
                const areaItems = results[i];
                const match = areaItems.find(m => m.target === query);
                if(match) {
                    foundItem = match;
                    foundArea = i + 1; // area index b·∫Øt ƒë·∫ßu t·ª´ 0
                    break;
                }
            }

            if(foundItem) {
                const parsed = JSON.parse(foundItem.data);
                // G·∫Øn th√™m Area v√†o data ƒë·ªÉ hi·ªÉn th·ªã
                parsed.area = foundArea; 
                container.innerHTML = generateMineCard(parsed, foundItem, false);
            } else {
                container.innerHTML = '<div class="col-span-full text-center text-red-400 py-4 bg-slate-800 rounded border border-slate-700">‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i n√†y ƒëang ƒë√†o kho√°ng ·ªü b·∫•t k·ª≥ t·∫ßng n√†o.</div>';
            }
        } catch(e) {
            console.error(e);
            container.innerHTML = '<div class="col-span-full text-center text-red-400">L·ªói k·∫øt n·ªëi API.</div>';
        }
    }
    
    // --- Scan All Logic (Gi·ªØ nguy√™n) ---
    async function minerals_scanAll() {
        const container = document.getElementById('minerals-result-area');
        const status = document.getElementById('scan-status');
        container.innerHTML = '';
        status.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu 11 t·∫ßng...';

        const promises = [];
        for(let i=1; i<=11; i++) promises.push(fetch(getApiUrl(`/api/score_list?type=battle_mine&area=${i}`)).then(r=>r.json()));
        
        try {
            const results = await Promise.all(promises);
            const flat = results.flat(); // Ch·ªâ d√πng ƒë·ªÉ ƒë·∫øm t·ªïng
            status.textContent = `ƒêang l·ªçc VIP trong ${flat.length} m·ªè...`;

            let html = '';
            let count = 0;
            
            // Duy·ªát qua t·ª´ng t·∫ßng ƒë·ªÉ gi·ªØ th√¥ng tin Area
            for(let i=0; i<results.length; i++) {
                const areaItems = results[i];
                const currentArea = i + 1;
                
                areaItems.forEach(m => {
                    try {
                        const parsed = JSON.parse(m.data);
                        parsed.area = currentArea; // G√°n t·∫ßng th·ªß c√¥ng v√¨ API scanAll ƒë√¥i khi thi·∫øu
                        const info = extractMinerInfo(parsed);
                        if(checkTargetValuable(info.rewards, info.times)) {
                            html += generateMineCard(parsed, m, true);
                            count++;
                        }
                    } catch(e){}
                });
            }

            if(count === 0) container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">Kh√¥ng c√≥ m·ªè n√†o c√≥ ƒë·ªì gi√° tr·ªã (>60p + item).</div>';
            else container.innerHTML = html;
            
            status.textContent = `T√¨m th·∫•y ${count} m·ªè VIP.`;

        } catch(e) {
            status.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu.';
        }
    }

    // --- Helpers: Generate Card (C·∫≠p nh·∫≠t n√∫t Theo D√µi) ---
    function generateMineCard(data, item, isMini) {
        const { rewards, times, info, area, rare } = extractMinerInfo(data);
        const displayArea = area || data.area || '?'; // L·∫•y t·∫ßng ch√≠nh x√°c
        
        let rewardHtml = '';
        for (const key in rewards) {
            const r = rewards[key];
            if(r.type === 'currency' || r.type === 'item' || r.type === 'material') {
                const imgUrl = `https://cmangax8.com/assets/img/level/${r.type}/${key}.png`;
                rewardHtml += `<div class="text-center" title="${key}">
                    <img src="${imgUrl}" class="h-6 w-auto mx-auto object-contain" onerror="this.style.display='none'">
                    <span class="text-[10px] block">${r.amount}</span>
                </div>`;
            }
        }

        const avatar = info.avatar ? `https://cmangax8.com/assets/tmp/avatar/${info.avatar}` : 'https://placehold.co/50';
        const mineImg = `https://cmangax8.com/assets/img/level/icon/mine/${rare||'default'}.png`;

        // N√∫t Theo D√µi: Truy·ªÅn c·∫£ ID v√† T·∫ßng v√†o h√†m monitor_add_quick
        const trackBtn = `
            <button onclick="monitor_add_quick('${item.target}', ${displayArea})" 
                class="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold py-1 rounded flex items-center justify-center gap-1 transition">
                <span>üîî Theo d√µi</span>
            </button>
        `;

        return `
            <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-600 shadow-lg flex flex-col relative hover:border-blue-500 transition group">
                <div class="bg-slate-700 p-2 text-center font-bold text-white text-xs flex justify-between items-center px-3">
                    <span>T·∫ßng ${displayArea}</span>
                    <span class="${times>=60?'text-green-400':'text-yellow-400'}">${times} ph√∫t</span>
                </div>
                <div class="p-3 flex flex-col items-center flex-1">
                    <div class="relative w-16 h-16 mb-2">
                         <img src="${mineImg}" class="w-full h-full object-contain opacity-80">
                         <img src="${avatar}" class="absolute bottom-0 right-0 w-8 h-8 rounded-full border-2 border-slate-700 bg-slate-800">
                    </div>
                    <div class="font-bold text-blue-300 text-sm truncate w-full text-center" title="${info.name}">${info.name || 'No Name'}</div>
                    <div class="text-[10px] text-gray-500 font-mono mb-2 bg-slate-900 px-2 rounded">${item.target}</div>
                    
                    <div class="grid grid-cols-4 gap-1 w-full mt-auto pt-2 border-t border-slate-600 min-h-[40px]">
                        ${rewardHtml || '<span class="col-span-4 text-[10px] text-gray-500 text-center py-2">Ch∆∞a c√≥ qu√†</span>'}
                    </div>
                    ${trackBtn}
                </div>
            </div>
        `;
    }
    
    // Helper c≈© (Gi·ªØ nguy√™n)
    const rewardsExclusionList = ['medicinal_exp_1', 'medicinal_exp_2', 'medicinal_exp_3', 'job_exp_3'];
    function extractMinerInfo(data) {
        let rewards = {};
        let times = 0;
        let info = (data.miner && data.miner.info) ? data.miner.info : (data.info || {});
        if (data.miner && data.miner.reward) { rewards = data.miner.reward; times = data.miner.times || 0; }
        else if (data.battle && data.battle.reward) { rewards = data.battle.reward; times = data.battle.times || 0; }
        return { rewards, times, info, area: data.area, rare: data.rare };
    }
    function checkTargetValuable(rewards, times) {
        if (!rewards || times <= 60) return false;
        for (const key in rewards) {
            const item = rewards[key];
            if ((item.type === 'item' || item.type === 'material') && !rewardsExclusionList.includes(key)) return true;
        }
        return false;
    }
// ================= 4. DONATION LOGIC (UPDATED) =================

// --- Init & Load ---
async function initDonation() {
    // 1. T·∫£i l·ªãch s·ª≠ chung t·ª´ GitHub
    await loadGithubHistory();
    
    // 2. Load c√†i ƒë·∫∑t t·ª´ LocalStorage (ID t√¥ng hi·ªán t·∫°i)
    CURRENT_DONATION_GUILD_ID = document.getElementById('donate-guild-id').value.trim();
    localStorage.setItem('donate_guild_id', CURRENT_DONATION_GUILD_ID);
    
    // ƒê·∫∑t URL m·∫∑c ƒë·ªãnh v√†o √¥ input
    const [user, repo] = GITHUB_HISTORY_URL.match(/githubusercontent\.com\/([^/]+)\/([^/]+)\/main/).slice(1, 3);
    document.getElementById('sync-url-input').value = `https://raw.githubusercontent.com/${user}/${repo}/main/donation_history.json`;


    // 3. Hi·ªÉn th·ªã th·ªëng k√™ cho ID hi·ªán t·∫°i
    if (CURRENT_DONATION_GUILD_ID) {
        // T·∫£i d·ªØ li·ªáu h√¥m nay (t∆∞∆°ng ƒë∆∞∆°ng b·∫•m check th·ªß c√¥ng)
        donation_check(true, CURRENT_DONATION_GUILD_ID);
    } else {
        document.getElementById('monthly-stats-title').textContent = 'Vui l√≤ng nh·∫≠p ID T√¥ng M√¥n.';
        document.getElementById('auto-check-status').textContent = 'T·ª± ƒë·ªông check ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang GitHub Actions (23:40 ICT)';
    }
}

// H√†m m·ªõi: T·∫£i l·ªãch s·ª≠ t·ª´ GitHub
async function loadGithubHistory() {
    try {
        const url = document.getElementById('sync-url-input').value.trim();
        if (!url || url.includes('YOUR_USERNAME')) {
            console.warn("GitHub History URL is not configured or is using placeholder. Skipping auto-load.");
            SHARED_GITHUB_HISTORY = {};
            return;
        }

        const response = await fetch(url);
        if (!response.ok) {
            console.warn("Could not load GitHub History file. Maybe file doesn't exist yet or URL is wrong.");
            SHARED_GITHUB_HISTORY = {};
            return;
        }
        SHARED_GITHUB_HISTORY = await response.json();
        console.log("Loaded shared history from GitHub successfully.");
    } catch (e) {
        console.error("Error fetching shared history:", e);
        SHARED_GITHUB_HISTORY = {};
    }
}


// --- Core Check Function ---
async function donation_check(isManual, guildIdToCheck = null) {
    const guildId = guildIdToCheck || document.getElementById('donate-guild-id').value.trim();
    if(!guildId) { if(isManual) alert('Nh·∫≠p ID Guild'); return false; }
    
    if (isManual) {
        CURRENT_DONATION_GUILD_ID = guildId;
        localStorage.setItem('donate_guild_id', CURRENT_DONATION_GUILD_ID);
        document.getElementById('guild-id-display').textContent = guildId;
    }

    const tbody = document.getElementById('donate-list');
    if (isManual) tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8"><div class="loader mx-auto mb-2"></div>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
    
    let success = false;
    let members = [];
    let donatedCount = 0;
    let dailyDonatedIds = {};

    try {
        // L·∫•y d·ªØ li·ªáu API
        const [memRes, infoRes] = await Promise.all([
            fetch(getApiUrl(`/api/game_guild_member?waiting=0&guild=${guildId}`)),
            fetch(getApiUrl(`/api/get_data_by_id?table=game_guild&data=data,donate&id=${guildId}`))
        ]);

        members = await memRes.json();
        const infoWrap = await infoRes.json();
        
        if(!infoWrap.data) throw new Error(`Kh√¥ng t√¨m th·∫•y Guild ID ${guildId}`);
        
        const guildData = JSON.parse(infoWrap.data); // Data t√™n, avatar guild
        const donationMap = infoWrap.donate ? JSON.parse(infoWrap.donate) : {};
        
        // C·∫≠p nh·∫≠t Header Guild
        if(isManual) {
            document.getElementById('guild-name-display').textContent = guildData.name + (guildData.tag ? ` (${guildData.tag})` : '');
            document.getElementById('guild-avatar-img').src = getGuildAvatarUrl(guildData.avatar);
        }

        const rows = members.map(m => {
            const id = m.id_game_character;
            const info = JSON.parse(m.info); // L·∫•y info.avatar, info.name
            const amt = parseInt(donationMap[id] || 0);

            if(amt > 0) {
                donatedCount++;
                dailyDonatedIds[id] = true;
            }

            return {
                id: id,
                name: info.name,
                avatar: info.avatar,
                role: m.role,
                amt: amt,
                lastOnline: m.last_online
            };
        });
        
        // L∆∞u l·ªãch s·ª≠ Local
        if (donatedCount > 0) { saveDonationHistoryLocal(guildId, dailyDonatedIds); }

        if (isManual) {
            // Update Stats Cards
            document.getElementById('donate-total').textContent = members.length;
            document.getElementById('donate-done').textContent = donatedCount;
            document.getElementById('donate-percent').textContent = members.length ? ((donatedCount/members.length)*100).toFixed(1)+'%' : '0%';

            // Render Table H√¥m Nay
            rows.sort((a,b) => b.amt - a.amt);
            tbody.innerHTML = rows.map(r => `
                <tr class="hover:bg-slate-700/50 transition border-b border-slate-700/50 last:border-0">
                    <td class="px-6 py-3 flex items-center gap-3">
                        <img src="${getAvatarUrl(r.avatar)}" class="w-8 h-8 rounded shadow-sm object-cover" onerror="this.src='https://placehold.co/32'"/>
                        <span class="font-medium text-white">${r.name}</span>
                    </td>
                    <td class="px-6 py-3 ">${getRoleName(r.role)}</td>
                    <td class="px-6 py-3 text-right">
                        ${r.amt > 0 
                            ? `<span class="text-green-400 font-bold bg-green-400/10 px-2 py-1 rounded">${formatNumber(r.amt)}</span>` 
                            : `<span class="text-red-500 text-xs">Ch∆∞a c·ªëng</span>`}
                    </td>
                    <td class="px-6 py-3 text-right  text-xs">${r.lastOnline}</td>
                </tr>
            `).join('');
            
            // Render B·∫£ng Th√°ng (Logic Matrix M·ªõi)
            renderMonthlyStats(guildId, members);
        }
        success = true;

    } catch(e) {
        console.error(e);
        if (isManual) tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-400">L·ªói: ${e.message}</td></tr>`;
    }
    return success;
}

// --- History Storage/Retrieval (LOCAL) ---

function getTodayDate() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function getCurrentMonthKey() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`;
}

// L·∫•y to√†n b·ªô l·ªãch s·ª≠ t·ª´ Local Storage
function getAllDonationHistoryLocal() {
    try {
        return JSON.parse(localStorage.getItem(DONATION_STORAGE_KEY) || '{}');
    } catch (e) {
        console.error("L·ªói parse LocalStorage:", e);
        return {};
    }
}

// L∆∞u l·ªãch s·ª≠ c·ªëng v√†ng v√†o Local Storage
function saveDonationHistoryLocal(guildId, donatedIds) {
    const history = getAllDonationHistoryLocal();
    const monthKey = getCurrentMonthKey();
    const dateKey = getTodayDate();
    
    if (!history[guildId]) history[guildId] = {};
    if (!history[guildId][monthKey]) history[guildId][monthKey] = {};

    if (Object.keys(donatedIds).length > 0) {
        history[guildId][monthKey][dateKey] = donatedIds;
        localStorage.setItem(DONATION_STORAGE_KEY, JSON.stringify(history));
        console.log(`Donation history saved locally for ${guildId} on ${dateKey}.`);
    }
}


// --- ONE-WAY SYNCHRONIZATION FUNCTION (GitHub ‚Üí Local) ---
async function syncFromGithubToLocal() {
    const url = document.getElementById('sync-url-input').value.trim();
    if(!url || url.includes('YOUR_USERNAME')) { alert('Vui l√≤ng ki·ªÉm tra l·∫°i URL Raw File JSON tr√™n GitHub.'); return; }
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP Error! Status: ${response.status}. Ki·ªÉm tra link c√≥ ph·∫£i l√† link RAW kh√¥ng.`);
        }
        const remoteHistory = await response.json();

        if (typeof remoteHistory !== 'object' || remoteHistory === null) {
            throw new Error('File kh√¥ng ph·∫£i l√† ƒë·ªãnh d·∫°ng JSON l·ªãch s·ª≠ h·ª£p l·ªá.');
        }

        const localHistory = getAllDonationHistoryLocal();
        const mergedHistory = {...localHistory}; // B·∫Øt ƒë·∫ßu v·ªõi d·ªØ li·ªáu local

        // Logic h·ª£p nh·∫•t (merge): D·ªØ li·ªáu t·ª´ file GitHub s·∫Ω H·ª¢P NH·∫§T v√†o Local Storage
        for (const guildId in remoteHistory) {
            if (!mergedHistory[guildId]) mergedHistory[guildId] = {};
            
            const remoteGuild = remoteHistory[guildId];

            // H·ª£p nh·∫•t danh s√°ch th√†nh vi√™n (c·∫ßn cho vi·ªác hi·ªÉn th·ªã t√™n)
            if(remoteGuild.members) {
                mergedHistory[guildId].members = remoteGuild.members;
            }

            // H·ª£p nh·∫•t th√°ng
            for (const monthKey in remoteGuild) {
                if(monthKey === 'members') continue; 
                
                if (!mergedHistory[guildId][monthKey]) mergedHistory[guildId][monthKey] = {};
                
                const remoteMonth = remoteGuild[monthKey];

                // H·ª£p nh·∫•t ng√†y (D·ªØ li·ªáu ng√†y t·ª´ Remote s·∫Ω GHI ƒê√à d·ªØ li·ªáu Local n·∫øu tr√πng ng√†y)
                for (const dateKey in remoteMonth) {
                    mergedHistory[guildId][monthKey][dateKey] = remoteMonth[dateKey];
                }
            }
        }

        // L∆∞u l·∫°i d·ªØ li·ªáu ƒë√£ h·ª£p nh·∫•t v√†o Local Storage
        localStorage.setItem(DONATION_STORAGE_KEY, JSON.stringify(mergedHistory));
        
        // C·∫≠p nh·∫≠t bi·∫øn SHARED_GITHUB_HISTORY ƒë·ªÉ hi·ªÉn th·ªã th·ªëng k√™ m·ªõi nh·∫•t
        SHARED_GITHUB_HISTORY = remoteHistory; 
        
        alert('ƒê·ªìng b·ªô th√†nh c√¥ng! D·ªØ li·ªáu t·ª´ GitHub ƒë√£ ƒë∆∞·ª£c h·ª£p nh·∫•t v√†o Local Storage c·ªßa tr√¨nh duy·ªát.');
        
        // Re-render the current guild's stats after successful import
        if (CURRENT_DONATION_GUILD_ID) {
            donation_check(true);
        }

    } catch (e) {
        alert(`L·ªói ƒê·ªìng B·ªô: ${e.message}`);
        console.error(e);
    }
}


// --- Rendering Stats (S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ GitHub V√Ä Local) ---

async function renderMonthlyStats(guildId, membersList) {
    // 1. X√°c ƒë·ªãnh ngu·ªìn d·ªØ li·ªáu (GitHub hay Local)
    let historySource = getAllDonationHistoryLocal(); // M·∫∑c ƒë·ªãnh local
    // N·∫øu c√≥ d·ªØ li·ªáu GitHub ƒë√£ sync, ∆∞u ti√™n d√πng n√≥
    if (SHARED_GITHUB_HISTORY[guildId]) {
        historySource = SHARED_GITHUB_HISTORY;
    }

    // 2. Chu·∫©n b·ªã danh s√°ch th√†nh vi√™n ƒë·∫ßy ƒë·ªß (c√≥ avatar)
    const memberMap = membersList.map(m => {
        const info = JSON.parse(m.info);
        return {
            id: m.id_game_character,
            name: info.name,
            avatar: info.avatar,
            role: m.role
        };
    }).sort((a,b) => a.role - b.role); // S·∫Øp x·∫øp theo ch·ª©c v·ª•

    // 3. X√°c ƒë·ªãnh s·ªë ng√†y trong th√°ng hi·ªán t·∫°i
    const d = new Date();
    const year = d.getFullYear();
    const month = d.getMonth() + 1;
    const monthKey = `${year}-${String(month).padStart(2,'0')}`;
    const daysInMonth = new Date(year, month, 0).getDate(); // S·ªë ng√†y c·ªßa th√°ng

    // 4. L·∫•y d·ªØ li·ªáu l·ªãch s·ª≠ c·ªßa th√°ng n√†y
    const currentMonthHistory = (historySource[guildId] && historySource[guildId][monthKey]) || {};

    // 5. Render HEADER (C√°c ng√†y)
    const thead = document.getElementById('monthly-stats-header');
    let headerHTML = `<tr>
        <th class="p-3 text-left min-w-[50px] bg-slate-800">#</th>
        <th class="p-3 text-left min-w-[150px] bg-slate-800">Th√†nh vi√™n</th>`;
    
    const dateKeys = [];
    for(let i=1; i<=daysInMonth; i++) {
        const dayStr = String(i).padStart(2, '0');
        headerHTML += `<th class="p-2 min-w-[40px] text-center ">${i}</th>`;
        dateKeys.push(`${monthKey}-${dayStr}`); // VD: 2024-05-01
    }
    headerHTML += `</tr>`;
    thead.innerHTML = headerHTML;
    document.getElementById('monthly-stats-title').innerHTML = `Th·ªëng k√™ th√°ng ${month}/${year}`;

    // 6. Render BODY (D·ªØ li·ªáu t·ª´ng ng∆∞·ªùi)
    const tbody = document.getElementById('monthly-stats-list');
    
    if (memberMap.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${daysInMonth + 2}" class="p-4 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu th√†nh vi√™n.</td></tr>`;
        return;
    }

    tbody.innerHTML = memberMap.map((mem, index) => {
        let rowHTML = `<tr class="hover:bg-slate-700/50 transition">
            <td class="p-3  font-mono text-xs">${index+1}</td>
            <td class="p-3 font-medium text-white flex items-center gap-2">
                <img src="${getAvatarUrl(mem.avatar)}" class="w-6 h-6 rounded object-cover" onerror="this.src='https://placehold.co/20'"/>
                <span class="truncate max-w-[120px]" title="${mem.name}">${mem.name}</span>
            </td>`;
        
        // Duy·ªát t·ª´ng ng√†y
        dateKeys.forEach(dateKey => {
            // Ki·ªÉm tra trong history c√≥ ng√†y n√†y kh√¥ng
            const dayData = currentMonthHistory[dateKey];
            // dayData l√† object { 'ID_Member': true/false/amount } ho·∫∑c undefined
            
            let cellContent = `<span class="text-slate-600 text-xs">.</span>`;
            
            if (dayData && dayData[mem.id]) {
                // C√≥ c·ªëng
                cellContent = `<span class="text-green-400 font-bold">‚úî</span>`;
            } else if (dayData) {
                // Ng√†y ƒë√≥ c√≥ d·ªØ li·ªáu nh∆∞ng ID n√†y kh√¥ng c√≥ -> Kh√¥ng c·ªëng
                // (Logic n√†y ch·ªâ ƒë√∫ng n·∫øu ng√†y ƒë√≥ ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n l·ªãch s·ª≠)
                cellContent = `<span class="text-red-500 font-bold text-xs">x</span>`;
            }

            // *L∆∞u √Ω*: Logic tr√™n GitHub Sync th∆∞·ªùng ch·ªâ l∆∞u list ID ƒë√£ c·ªëng. 
            // N·∫øu mu·ªën hi·ªán d·∫•u X ch√≠nh x√°c, c·∫ßn bi·∫øt ng√†y ƒë√≥ "ƒë√£ check ch∆∞a".
            // T·∫°m th·ªùi: N·∫øu trong ng√†y ƒë√≥ c√≥ b·∫•t k·ª≥ ai c·ªëng -> coi l√† ƒë√£ check -> ai thi·∫øu l√† X.
            // N·∫øu ng√†y ƒë√≥ ch∆∞a c√≥ d·ªØ li·ªáu g√¨ -> hi·ªán d·∫•u ch·∫•m.
            
            const isDayChecked = dayData && Object.keys(dayData).length > 0;
            if (isDayChecked && !dayData[mem.id]) {
                 cellContent = `<span class="text-red-500 font-bold text-xs">‚úï</span>`;
            }

            rowHTML += `<td class="p-2 text-center border-l border-slate-700/50">${cellContent}</td>`;
        });

        rowHTML += `</tr>`;
        return rowHTML;
    }).join('');
}

// --- General Helpers ---
function getRoleName(r) {
    return {1:'T√¥ng Ch·ªß',2:'Ph√≥ T√¥ng',3:'Tr∆∞·ªüng L√£o',4:'Th√†nh Vi√™n',5:'T√¢n Binh'}[r] || r;
}
// KH√îNG C·∫¶N setupAutoCheck() n·ªØa v√¨ GitHub Actions ƒë√£ x·ª≠ l√Ω.

    // ================= 4. GUILD WAR LOGIC =================
    async function guildwar_filter() {
        const name = document.getElementById('gw-name-input').value.trim().toLowerCase();
        if(!name) { alert('Nh·∫≠p t√™n Guild'); return; }

        const container = document.getElementById('gw-result');
        container.innerHTML = '<div class="text-center p-4">ƒêang t·∫£i danh s√°ch ƒëi·ªÉm server... (API 1/2)</div>';

        try {
            // Step 1: Get Score List
            const scoreRes = await fetch(getApiUrl('/api/score_list?type=guild_battle_player&limit=1000'));
            const scoreData = await scoreRes.json();

            // Step 2: Find Guild ID from Name in Score List
            let guildId = null;
            const scoreMap = {};

            for(const item of scoreData) {
                const info = JSON.parse(item.info);
                scoreMap[info.id] = parseInt(item.score);
                if(!guildId && info.guild && info.guild.name.toLowerCase() === name) {
                    guildId = info.guild.id;
                }
            }

            if(!guildId) throw new Error("Kh√¥ng t√¨m th·∫•y Guild t√™n n√†y trong b·∫£ng x·∫øp h·∫°ng.");

            container.innerHTML = `<div class="text-center p-4 text-blue-400">T√¨m th·∫•y Guild ID: ${guildId}. ƒêang t·∫£i th√†nh vi√™n...</div>`;

            // Step 3: Get Members
            const memRes = await fetch(getApiUrl(`/api/game_guild_member?waiting=0&guild=${guildId}`));
            const members = await memRes.json();

            // Step 4: Merge
            const final = members.map(m => {
                const info = JSON.parse(m.info);
                return {
                    name: info.name,
                    score: scoreMap[info.id] || 0
                };
            }).sort((a,b) => b.score - a.score);

            // Step 5: Render
            let html = `<h3 class="font-bold text-center text-xl mb-4 text-white">K·∫øt qu·∫£: ${name.toUpperCase()}</h3>
            <table class="w-full text-sm">
                <thead class="bg-slate-800"><tr><th class="p-2 text-left">#</th><th class="p-2 text-left">T√™n</th><th class="p-2 text-right">ƒêi·ªÉm</th></tr></thead>
                <tbody>`;
            
            html += final.map((item, i) => {
                let cls = '';
                if(i===0) cls='top-1'; else if(i===1) cls='top-2'; else if(i===2) cls='top-3';
                return `<tr class="border-b border-slate-700 hover:bg-slate-700/50 ${cls}">
                    <td class="p-2">${i+1}</td>
                    <td class="p-2 font-bold">${item.name}</td>
                    <td class="p-2 text-right font-mono">${formatNumber(item.score)}</td>
                </tr>`;
            }).join('');
            html += '</tbody></table>';
            container.innerHTML = html;

        } catch(e) {
            container.innerHTML = `<div class="text-center p-4 text-red-400">L·ªói: ${e.message}</div>`;
        }
    }

</script>
</body>
</html>
